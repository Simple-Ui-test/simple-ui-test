/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
define(["ojs/ojcore","jquery","ojs/ojdataprovideradapter-base"],(function(e,t,n){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function s(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l=function(t){function n(e){var t;return r(this,n),(t=s(this,o(n).call(this,e))).tableDataSource=e,t.FetchByKeysResults=function(){return function e(t,a,i){r(this,e),this._parent=t,this.fetchParameters=a,this.results=i,this[n._FETCHPARAMETERS]=a,this[n._RESULTS]=i}}(),t.ContainsKeysResults=function(){return function e(t,a,i){r(this,e),this._parent=t,this.containsParameters=a,this.results=i,this[n._CONTAINSPARAMETERS]=a,this[n._RESULTS]=i}}(),t.Item=function(){return function e(t,a,i){r(this,e),this._parent=t,this.metadata=a,this.data=i,this[n._METADATA]=a,this[n._DATA]=i}}(),t.FetchByOffsetResults=function(){return function e(t,a,i,s){r(this,e),this._parent=t,this.fetchParameters=a,this.results=i,this.done=s,this[n._FETCHPARAMETERS]=a,this[n._RESULTS]=i,this[n._DONE]=s}}(),t.FetchListParameters=function(){return function e(t,a,i){r(this,e),this._parent=t,this.size=a,this.sortCriteria=i,this[n._SIZE]=a,this[n._SORTCRITERIA]=i}}(),t._addTableDataSourceEventListeners(),t[n._OFFSET]=0,t._ignoreDataSourceEvents=new Array,t}var a,l,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(n,t),a=n,(l=[{key:"destroy",value:function(){this._removeTableDataSourceEventListeners()}},{key:"containsKeys",value:function(e){var t=this,a=[];return e[n._KEYS].forEach((function(e){a.push(t.tableDataSource.get(e))})),Promise.all(a).then((function(a){var r=new Set;return a.map((function(e){null!=e&&r.add(e[n._KEY])})),Promise.resolve(new t.ContainsKeysResults(t,e,r))}))}},{key:"fetchByKeys",value:function(e){var t=this,a=[];return e[n._KEYS].forEach((function(e){a.push(t.tableDataSource.get(e))})),Promise.all(a).then((function(a){var r=new Map;return a.map((function(e){if(null!=e){var a=e[n._KEY],i=e[n._DATA];r.set(a,new t.Item(t,new t.ItemMetadata(t,a),i))}})),Promise.resolve(new t.FetchByKeysResults(t,e,r))}))}},{key:"fetchByOffset",value:function(e){var t=this,a=null!=e?e[n._SIZE]:-1,r=null!=e?e[n._SORTCRITERIA]:null,i=null!=e&&e[n._OFFSET]>0?e[n._OFFSET]:0,s=new this.FetchListParameters(this,a,r);return this._startIndex=0,this._getFetchFunc(s,i)(s,!0).then((function(a){var r=a[n._VALUE],i=a[n._DONE],s=r[n._DATA],o=r[n._METADATA].map((function(e){return e[n._KEY]})),u=new Array;return s.map((function(e,n){u.push(new t.Item(t,new t.ItemMetadata(t,o[n]),s[n]))})),new t.FetchByOffsetResults(t,e,u,i)}))}},{key:"fetchFirst",value:function(e){return this._isPagingModelTableDataSource()||(this._startIndex=0),new this.AsyncIterable(new this.AsyncIterator(this._getFetchFunc(e),e))}},{key:"getCapability",value:function(e){return e==n._SORT&&"full"==this.tableDataSource.getCapability(e)?{attributes:"multiple"}:"fetchByKeys"==e||"fetchByOffset"==e?{implementation:"lookup"}:null}},{key:"getTotalSize",value:function(){return Promise.resolve(this.tableDataSource.totalSize())}},{key:"isEmpty",value:function(){return this.tableDataSource.totalSize()>0?"no":"yes"}},{key:"getPage",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPage():-1}},{key:"setPage",value:function(e,t){return this._isPagingModelTableDataSource()?this.tableDataSource.setPage(e,t):Promise.reject(null)}},{key:"getStartItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getStartItemIndex():-1}},{key:"getEndItemIndex",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getEndItemIndex():-1}},{key:"getPageCount",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.getPageCount():-1}},{key:"totalSize",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSize():-1}},{key:"totalSizeConfidence",value:function(){return this._isPagingModelTableDataSource()?this.tableDataSource.totalSizeConfidence():null}},{key:"_getFetchFunc",value:function(e,t){var a=this;if(null!=e&&null!=e[n._SORTCRITERIA]){var r=e[n._SORTCRITERIA][0][n._ATTRIBUTE],i=e[n._SORTCRITERIA][0][n._DIRECTION];return this._ignoreSortEvent=!0,this._isPagingModelTableDataSource()||(this._startIndex=0),function(e,r){return function(i,s){if(s){var o={};return o[n._KEY]=e,o[n._DIRECTION]=r,a[n._OFFSET]=0,a.tableDataSource.sort(o).then((function(){return a._ignoreSortEvent=!1,a._getTableDataSourceFetch(i,t)(i)}))}return a._getTableDataSourceFetch(i,t)(i)}}(r,i)}return this._getTableDataSourceFetch(e,t)}},{key:"_getTableDataSourceFetch",value:function(e,t){var a=this;return function(e,r){var i={};if(t=t>0?t:0,null!=a._startIndex&&(i[n._STARTINDEX]=a._startIndex+t),i[n._PAGESIZE]=null!=e&&e[n._SIZE]>0?e[n._SIZE]:null,!a._isPagingModelTableDataSource()&&e[n._SILENT]&&(i[n._SILENT]=e[n._SILENT]),null!=a.tableDataSource[n._SORTCRITERIA]&&null==e[n._SORTCRITERIA]){e[n._SORTCRITERIA]=[];var s=new a.SortCriterion(a,a.tableDataSource[n._SORTCRITERIA][n._KEY],a.tableDataSource[n._SORTCRITERIA][n._DIRECTION]);e[n._SORTCRITERIA].push(s)}return i[n._FETCHTYPE]=e[n._FETCHTYPE],a._isFetching=!0,new Promise((function(t,r){a._fetchResolveFunc=t,a._fetchRejectFunc=r,a._fetchParams=e,a._requestEventTriggered||(a._isPagingModelTableDataSource()||i[n._SILENT]||a._ignoreDataSourceEvents.push(!0),a.tableDataSource.fetch(i).then((function(r){if(a._isPagingModelTableDataSource()||i[n._SILENT]||a._ignoreDataSourceEvents.pop(),null!==r){a._isFetching=!1,void 0===r&&((r={})[n._KEYS]=[],r[n._DATA]=[]);var s=[];null!=r[n._KEYS]&&(s=r[n._KEYS].map((function(e){return new a.ItemMetadata(a,e)}))),null==a._startIndex&&(a._startIndex=0);var o=!1;a._startIndex=a._startIndex+r[n._DATA].length,("actual"==a.tableDataSource.totalSizeConfidence()&&a.tableDataSource.totalSize()>0&&r.startIndex+r[n._DATA].length>=a.tableDataSource.totalSize()||i[n._PAGESIZE]>0&&r[n._DATA].length<i[n._PAGESIZE]||0==r[n._DATA].length)&&(o=!0),a._fetchResolveFunc=null,a._fetchParams=null,t(o?new a.AsyncIteratorReturnResult(a,new a.FetchListResult(a,e,r[n._DATA],s)):new a.AsyncIteratorYieldResult(a,new a.FetchListResult(a,e,r[n._DATA],s)))}}),(function(e){a._isPagingModelTableDataSource()||i[n._SILENT]||a._ignoreDataSourceEvents.pop(),r(e)})))}))}}},{key:"_handleSync",value:function(t){var a=this;if(!(a._ignoreDataSourceEvents.length>0)){if(a._startIndex=null,t[n._STARTINDEX]>0&&(a._startIndex=t[n._STARTINDEX],a[n._OFFSET]=a._startIndex),a._fetchResolveFunc&&null!=t[n._KEYS]){a._isFetching=!1;var r=t[n._KEYS].map((function(e){return new a.ItemMetadata(a,e)})),i=!1;"actual"==a.tableDataSource.totalSizeConfidence()&&a.tableDataSource.totalSize()>0&&a._startIndex+t[n._DATA].length>=a.tableDataSource.totalSize()&&(i=!0),i?a._fetchResolveFunc(new a.AsyncIteratorReturnResult(a,new a.FetchListResult(a,a._fetchParams,t[n._DATA],r))):a._fetchResolveFunc(new a.AsyncIteratorYieldResult(a,new a.FetchListResult(a,a._fetchParams,t[n._DATA],r))),a._fetchResolveFunc=null,a._fetchParams=null}else a._requestEventTriggered||a.dispatchEvent(new e.DataProviderRefreshEvent);a._requestEventTriggered=!1}}},{key:"_handleAdd",value:function(t){var a=this,r=t[n._KEYS].map((function(e){return new a.ItemMetadata(a,e)})),i=new Set;t[n._KEYS].map((function(e){i.add(e)}));var s=new a.DataProviderAddOperationEventDetail(a,i,null,null,null,r,t[n._DATA],t[n._INDEXES]),o=new a.DataProviderMutationEventDetail(a,s,null,null);a.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleRemove",value:function(t){var a=this,r=t[n._KEYS].map((function(e){return new a.ItemMetadata(a,e)})),i=new Set;t[n._KEYS].map((function(e){i.add(e)}));var s=new a.DataProviderOperationEventDetail(a,i,r,t[n._DATA],t[n._INDEXES]),o=new a.DataProviderMutationEventDetail(a,null,s,null);a.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleReset",value:function(t){this._requestEventTriggered||this._isPagingModelTableDataSource()||(this._startIndex=0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleSort",value:function(t){this._ignoreSortEvent||(this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleChange",value:function(t){var a=this,r=t[n._KEYS].map((function(e){return new a.ItemMetadata(a,e)})),i=new Set;t[n._KEYS].map((function(e){i.add(e)}));var s=new a.DataProviderOperationEventDetail(a,i,r,t[n._DATA],t[n._INDEXES]),o=new a.DataProviderMutationEventDetail(a,null,null,s);a.dispatchEvent(new e.DataProviderMutationEvent(o))}},{key:"_handleRefresh",value:function(t){this._isFetching||this._requestEventTriggered||(null!=t[n._OFFSET]?this._startIndex=t[n._OFFSET]:this._startIndex=null,this.dispatchEvent(new e.DataProviderRefreshEvent)),this._requestEventTriggered=!1}},{key:"_handleRequest",value:function(t){this._ignoreDataSourceEvents.length>0||void 0!==e.Model&&t instanceof e.Model||this._isFetching||(t[n._STARTINDEX]>0&&0==this.getStartItemIndex()&&(this._startIndex=t[n._STARTINDEX]),this._requestEventTriggered=!0,this.dispatchEvent(new e.DataProviderRefreshEvent))}},{key:"_handleError",value:function(e){this._fetchRejectFunc&&this._fetchRejectFunc(e),this._isFetching=!1,this._requestEventTriggered=!1}},{key:"_handlePage",value:function(t){this._isFetching=!1,this._requestEventTriggered=!1;var n={};n.detail=t,this.dispatchEvent(new e.GenericEvent(e.PagingModel.EventType.PAGE,n))}},{key:"_addTableDataSourceEventListeners",value:function(){this.removeAllListeners(),this.addListener("sync",this._handleSync),this.addListener("add",this._handleAdd),this.addListener("remove",this._handleRemove),this.addListener("reset",this._handleReset),this.addListener("sort",this._handleSort),this.addListener("change",this._handleChange),this.addListener("refresh",this._handleRefresh),this.addListener("request",this._handleRequest),this.addListener("error",this._handleError),this.addListener("page",this._handlePage)}},{key:"_removeTableDataSourceEventListeners",value:function(){this.removeListener("sync"),this.removeListener("add"),this.removeListener("remove"),this.removeListener("reset"),this.removeListener("sort"),this.removeListener("change"),this.removeListener("refresh"),this.removeListener("request"),this.removeListener("error"),this.removeListener("page")}},{key:"_isPagingModelTableDataSource",value:function(){return null!=this.tableDataSource.getStartItemIndex}}])&&i(a.prototype,l),c&&i(a,c),n}(n);l._STARTINDEX="startIndex",l._SILENT="silent",l._SORTCRITERIA="sortCriteria",l._PAGESIZE="pageSize",l._OFFSET="offset",l._SIZE="size",l._CONTAINSPARAMETERS="containsParameters",l._RESULTS="results",l._FETCHTYPE="fetchType",e.EventTargetMixin.applyMixin(l),e.TableDataSourceAdapter=l,e.TableDataSourceAdapter=l}));