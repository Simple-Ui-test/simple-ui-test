define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger","./impl/sql-where-parser.min"],(function(e,r,n,t,s){"use strict";function l(t,s,l,o,u,a,i){return e.getCache().hasMatch(t,{ignoreSearch:!0}).then((function(c){return r.openStore(s).then((function(r){if(c)return e.getCache().match(t,{ignoreSearch:!0}).then((function(e){return"single"===e.headers.get("x-oracle-jscpt-resource-type")?Promise.resolve():r.find(l)}));var n=function(e){var r=e.url.split("/");if(r.length>1)return r[r.length-1].split("?")[0];return null}(t);return n?r.findByKey(n):Promise.resolve([])})).then((function(r){return e.getCache().match(t,{ignoreSearch:!0}).then((function(l){if(l){var c=!1,h=0;return r&&(h=r.length,a&&a>0&&(c=a<r.length,r=r.slice(a,r.length)),i&&i>0&&(c=i<=r.length,r=r.slice(0,i))),o(l).then((function(e){var t=e[0].resourceType,o={name:s,data:null!=r?r:e[0].data,resourceType:t};return u([o],l).then((function(e){return e.clone().text().then((function(r){if(!(null!=r&&r.length>0))return e;try{var t=JSON.parse(r);return null!=t.items&&(i&&(t.limit=parseInt(i,10)),a&&(t.offset=parseInt(a,10)),t.hasMore=c,t.totalResults=h),n.setResponsePayload(e,t)}catch(e){}}))}))}))}if(r&&Object.keys(r).length>0){var f=function(e){var r=e.url.split("/");if(r.length>1)return r.pop(),r.join("/");return null}(t);return f?n.requestToJSON(t).then((function(t){return t.url=f,n.requestFromJSON(t).then((function(n){return e.getCache().match(n,{ignoreSearch:!0}).then((function(e){if(e)return u([{name:s,data:[r],resourceType:"single"}],e)}))}))})):Promise.resolve()}return Promise.resolve()}))}))}))}function o(e){var r=[];if(null!=e){"?"===e.charAt(0)&&(e=e.slice(1));var n,t,s,l=(e=e||"").split("&");r=l.map((function(e){return(s=e.indexOf("="))>-1?(n=e.slice(0,s),t=u(t=e.slice(s+1))):(n=e,t=""),[n=u(n),t]}))}return{next:function(){var e=r.shift();return{done:void 0===e,value:e}}}}function u(e){return decodeURIComponent(e.replace(/\+/g," "))}return{getSimpleQueryHandler:function(e,r,s){return function(u,a){if("GET"==u.method||"HEAD"==u.method){t.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var i,c,h=u.url.split("?"),f=n._mapFindQuery(function(e,r){var n={};if(e&&e.length>1){var t,s,l,u,a={};t="undefined"==typeof URLSearchParams?o(e[1]):new URLSearchParams(e[1]).entries();do{null!=(s=t.next()).value&&(l=s.value[0],u=s.value[1],r&&-1!=r.indexOf(l)||(a["value."+l]=u))}while(!s.done);Object.keys(a).length>0&&(n.selector=a)}return n}(h,r),s);if(null!=a.jsonProcessor&&(i=a.jsonProcessor.shredder,c=a.jsonProcessor.unshredder),null!=i&&null!=c)return l(u,e,f,i,c)}return Promise.resolve()}},getOracleRestQueryHandler:function(e,r,u){return r=r||function(e){return function(e){var r={};if(e){var n,t=new s,l=e.split(";"),o={},u=[],a={};for(n=0;n<l.length;n++)a=t.parse(l[n],(function(e,r){"AND"!=(e=e.toUpperCase())&&"OR"!=e&&(r[0]="value."+r[0]);var n=r[0],t=r[1],s={};switch(e){case">":s[n]={$gt:t};break;case"<":s[n]={$lt:t};break;case">=":s[n]={$gte:t};break;case"<=":s[n]={$lte:t};break;case"=":s[n]={$eq:t};break;case"!=":s[n]={$ne:t};break;case"AND":s={$and:r};break;case"OR":s={$or:r};break;case"LIKE":t=t.replace("%",".+"),s[n]={$regex:t};break;case"BETWEEN":var l=[];l[0]={},l[1]={},l[0][n]={$gte:r[1]},l[1][n]={$lte:r[2]},s={$and:l}}return s})),u.push(a);u.length>1?o.$and=u:1==u.length&&(o=u[0]),Object.keys(o).length>0&&(r.selector=o)}return r}(e)},function(s,a){if("GET"==s.method||"HEAD"==s.method){t.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var i,c,h,f,d,p,g,v=s.url.split("?");c="undefined"==typeof URLSearchParams?o(v[1]):new URLSearchParams(v[1]).entries();do{null!=(h=c.next()).value&&(f=h.value[0],d=h.value[1],"q"==f?i=d:"limit"==f?p=d:"offset"==f&&(g=d))}while(!h.done);var m,y,P=n._mapFindQuery(r(i),u);if(null!=a.jsonProcessor&&(m=a.jsonProcessor.shredder,y=a.jsonProcessor.unshredder),null!=m&&null!=y)return l(s,e,P,m,y,g,p).then((function(e){return e?e.clone().text().then((function(r){if(null!=r&&r.length>0)try{var t=JSON.parse(r);return t.links?Promise.resolve(e):(t.links=[{rel:"self",href:s.url}],n.setResponsePayload(e,t).then((function(e){return Promise.resolve(e)})))}catch(e){}})):Promise.resolve()}))}return Promise.resolve()}}}}));