define(["./impl/logger"],(function(e){"use strict";function t(e){return e.headers.has("x-oracle-jscpt-cache-expiration-date")}function n(e){var t=e.get("Content-Type");return!(!t||!t.match(/.*text\/.*/)&&!t.match(/.*application\/.*json.*/))}function r(t,n){e.log("Offline Persistence Toolkit persistenceUtils: requestToJSON()"),n&&n._noClone||(t=t.clone());var r={};return a(t,r,["body","headers","signal"]),r.headers=o(t.headers),i(t,r)}function a(e,t,n){for(var r in e)"function"!=typeof e[r]&&0!==r.indexOf("_")&&-1===n.indexOf(r)&&(t[r]=e[r])}function o(t){var n={};if(t.entries){var r,a,o,i=t.entries();do{(r=i.next()).value&&(a=r.value[0],o=r.value[1],n[a]=o)}while(!r.done)}else t.forEach&&t.forEach((function(e,t){n[t]=e}));return function(t){var n=t.date;n||(e.log("Offline Persistence Toolkit persistenceUtils: Setting HTTP date header since it's null or not exposed"),n=(new Date).toUTCString(),t.date=n)}(n),n}function i(t,r){return r.body={},t instanceof Request&&(a=t.headers,(o=a.get("Content-Type"))&&-1!==o.indexOf("multipart/"))?function(t,n){if(e.log("Offline Persistence Toolkit persistenceUtils: Copying multipart payload"),"function"==typeof t.formData)return t.formData().then((function(e){var t,r,a,o,i={},s=e.entries();do{(r=(t=s.next()).value)&&(a=r[0],o=r[1],i[a]=o)}while(!t.done);return n.body.formData=i,n}));var r=t.headers.get("Content-Type");return t.text().then((function(e){for(var t=c(e,r),a={},o=0;o<t.length;o++)a[t[o].headers.name]=t[o].data;return n.body.formData=a,n}))}(t,r):t instanceof Request||n(t.headers)?t.text().then((function(e){return r.body.text=e,r})):t instanceof Request||"function"!=typeof t.arrayBuffer?Promise.reject(new Error({message:"payload body type is not supported"})):t.arrayBuffer().then((function(e){return e.byteLength>0&&(r.body.arrayBuffer=e),r}));var a,o}function s(t,n){e.log("Offline Persistence Toolkit persistenceUtils: responseToJSON()"),n&&n._noClone||(t=t.clone());var r={};return a(t,r,["body","headers"]),r.headers=o(t.headers),n&&n.excludeBody?Promise.resolve(r):i(t,r)}function l(t){e.log("Offline Persistence Toolkit persistenceUtils: requestFromJSON()");var n={};a(t,n,["headers","body","signal"]);var r=function(e,t){var n=!1,r=e.body;if(r.text&&r.text.length>0)t.body=r.text;else if(r.arrayBuffer)t.body=r.arrayBuffer;else if(r.formData){n=!0;var a=new FormData,o=r.formData;Object.keys(o).forEach((function(e){a.append(e,o[e])})),t.body=a}return n}(t,n);return n.headers=u(t,r),function(e,t){return Promise.resolve(new Request(e.url,t))}(t,n)}function u(e,t){var n=new Headers;return Object.keys(e.headers).forEach((function(r){("content-type"!==r||!t&&"content-type"===r)&&n.append(r,e.headers[r])})),n}function f(t){e.log("Offline Persistence Toolkit persistenceUtils: responseFromJSON()");var n={};return a(t,n,["headers","body"]),n.headers=u(t,!1),function(e,t){var n,r=e.body;r&&r.text?n=new Response(r.text,t):r&&r.arrayBuffer?(t.responseType="blob",n=new Response(r.arrayBuffer,t)):r&&r.blob?(t.responseType="blob",n=new Response(r.blob,t)):n=new Response(null,t);return Promise.resolve(n)}(t,n)}function c(t,n){e.log("Offline Persistence Toolkit persistenceUtils: parseMultipartFormData()");var r=n.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!r)throw new Error("not a valid multipart form data value.");var a,o=function(e){for(var t={},n={},r=e.split("\r\n"),a=0;a<r.length;a++){var o=r[a];if(0!==o.length){var i=o.split(";");if(1===i.length&&0===i[0].indexOf("Content-Type"))t.contentType=i[0].split(":")[1].trim();else for(var s=0;s<i.length;s++)if(-1!==i[s].indexOf("=")){var l=i[s].split("=");n[l[0].trim()]=l[1].substring(1,l[1].length-1)}}}return t.headers=n,t},i=function(e,t){var n=e.split("\r\n");return t&&t.indexOf("image")>=0?s(n[0],t):n[0]},s=function(e,t){var n=null;try{n=atob(e)}catch(e){return null}for(var r=new ArrayBuffer(n.length),a=new Uint8Array(r),o=0;o<n.length;o++)a[o]=n.charCodeAt(o);return new Blob([r],{type:t})},l=r[1]||r[2];if("string"==typeof t)a=t;else{var u=new Uint8Array(t);a=String.fromCharCode.apply(null,u)}for(var f=a.split(new RegExp(l)),c=[],d=1;d<f.length-1;d++){var p={},y=f[d].split("\r\n\r\n"),h=y[0],v=y[1],g=o(h);p.headers=g.headers,p.data=i(v,g.contentType),c.push(p)}return c}return{requestToJSON:r,requestFromJSON:l,responseToJSON:s,responseFromJSON:f,setResponsePayload:function(t,n){return e.log("Offline Persistence Toolkit persistenceUtils: setResponsePayload()"),s(t).then((function(e){var t=e.body;return t.arrayBuffer=null,t.blob=null,t.text=null,n instanceof ArrayBuffer?t.arrayBuffer=n:n instanceof Blob?t.blob=n:t.text=JSON.stringify(n),f(e)}))},parseMultipartFormData:c,isCachedResponse:t,isGeneratedEtagResponse:function(e){return e.headers.has("x-oracle-jscpt-etag-generated")},_isTextPayload:n,buildEndpointKey:function(t){e.log("Offline Persistence Toolkit persistenceUtils: buildEndpointKey() for Request with url: "+t.url);var n={url:t.url,id:Math.random().toString(36).replace(/[^a-z]+/g,"")};return JSON.stringify(n)},_cloneRequest:function(e){return r(e,{_noClone:!0}).then((function(e){return l(e).then((function(e){return e}))}))},_cloneResponse:function(e,t){return t=t||{},s(e,{_noClone:!0}).then((function(e){return f(e).then((function(e){return null!=t.url&&t.url.length>0&&null==e.headers.get("x-oracle-jscpt-response-url")&&e.headers.set("x-oracle-jscpt-response-url",t.url),e}))}))},_derivePayloadType:function(e,r){var a=r.headers.get("Content-Type"),o=e.responseType;return n(r.headers)?"text":t(r)||"blob"===o?"blob":a&&-1!==a.indexOf("image/")||"arraybuffer"===o?"arraybuffer":a&&-1!==a.indexOf("multipart/form-data")?"multipart":"text"},_mapData:function(e,t,n){var r=e||[],a=t||[];if(n){r=[],a=[];var o,i=null!=e?e.length:t.length;for(o=0;o<i;o++){var s=null!=e?{key:e[o]}:{key:null},l=null!=t?{metadata:s,data:t[o]}:{metadata:s,data:null},u=n.mapFields(l);r[o]=u.metadata.key,a[o]=u.data}}return{keys:r,data:a}},_unmapData:function(e,t,n){var r=e||[],a=t||[];if(n){r=[],a=[];var o,i=null!=e?e.length:t.length;for(o=0;o<i;o++){var s=null!=e?{key:e[o]}:{key:null},l=null!=t?{metadata:s,data:t[o]}:{metadata:s,data:null},u=n.unmapFields(l);r[o]=u.metadata.key,a[o]=u.data}}return{keys:r,data:a}},_mapFindQuery:function(e,t){if(e&&t){var n=function e(t){if(t){var n={};return Object.keys(t).forEach((function(r){if(r.startsWith("value.")){var a=t[r];a instanceof Object?(n.op=Object.keys(a)[0],n.value=a[n.op]):(n.op="$eq",n.value=a),n.attribute=r.substr(6,r.length)}else{var o=r;"$and"!=o&&"$or"!=o||(n.op=o,n.value=[],t[o].forEach((function(t,r){n.value[r]=e(t)})))}})),n}return null}(e.selector);n&&(e.selector=function e(t){if(t){var n={},r=t.op;return"$and"==r||"$or"==r?(n[r]=[],t.value.forEach((function(t,a){n[r][a]=e(t)}))):(n["value."+t.attribute]={},n["value."+t.attribute][t.op]=t.value),n}return null}(t.mapFilterCriterion(n)))}return e}}}));