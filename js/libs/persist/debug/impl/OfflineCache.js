define(["./defaultCacheHandler","../persistenceStoreManager","../persistenceUtils","./logger"],(function(e,r,t,n){"use strict";function o(e,r){if(!e)throw TypeError("A name must be provided to create an OfflineCache!");if(!r)throw TypeError("A persistence store must be provided to create an OfflineCache!");this._name=e,this._storeName=r,this._store=null}function i(e,r,t){if(t&&t.length)for(var n=0;n<t.length;n++){var o=t[n];if(s(e,r,o))return o.responseData}return null}function a(e,r,t){return function(n){var o;return o=t?n[t]:n,s(e,r,o)}}function s(e,r,t){if(e)return!0;if(!t||!r)return!1;var o=t.requestData.headers,i=t.responseData.headers,a=r.headers,s=i.vary;if(n.log("Offline Persistence Toolkit OfflineCache: Processing HTTP Vary header"),!s)return!0;if("*"===s.trim())return!1;for(var u=s.split(","),f=0;f<u.length;f++){var l=u[f].toLowerCase();l=l.trim();var c=a.get(l),h=o[l];if(n.log("Offline Persistence Toolkit OfflineCache: HTTP Vary header name: "+l),n.log("Offline Persistence Toolkit OfflineCache: Request HTTP Vary header value: "+c),n.log("Offline Persistence Toolkit OfflineCache: Cached HTTP Vary header value: "+h),!(!h&&!c||h&&c&&h===c))return!1}return!0}function u(r){if(r){n.log("Offline Persistence Toolkit OfflineCache: Converting cached entry to Response object");var t=[],o=r.bodyAbstract;return o?(t.push(Promise.resolve(JSON.parse(o))),delete r.bodyAbstract):t.push(Promise.resolve()),t.push(e.constructResponse(r)),Promise.all(t)}return Promise.resolve()}function f(r,t,n){if(t){var o=e.constructSearchCriteria(t,n);o.fields=["key","value"];var i=n&&n.ignoreVary;return r.find(o).then((function(e){return e&&e.length?e.filter(a(i,t,"value")).map((function(e){return e.key})):[]}))}return r.keys()}return o.prototype.getName=function(){return this._name},o.prototype.add=function(e){n.log("Offline Persistence Toolkit OfflineCache: add()");var r=this;return fetch(e).then((function(t){var n=t.clone();return r.put(e,t).then((function(){Promise.resolve(n)}))}))},o.prototype.addAll=function(e){n.log("Offline Persistence Toolkit OfflineCache: addAll()");var r=e.map(this.add,this);return Promise.all(r)},o.prototype.match=function(r,t){n.log("Offline Persistence Toolkit OfflineCache: match() for Request with url: "+r.url);var o=e.constructSearchCriteria(r,t),a=t&&t.ignoreVary;return this._getStore().then((function(e){return e.find(o)})).then((function(e){return u(i(a,r,e))})).then((function(t){if(t){var n=t[0],o=t[1];return e.fillResponseBodyWithShreddedData(r,n,o)}return Promise.resolve()}))},o.prototype.matchAll=function(r,t){n.log("Offline Persistence Toolkit OfflineCache: matchAll() for Request with url: "+r.url);var o=e.constructSearchCriteria(r,t),i=t&&t.ignoreVary;return this._getStore().then((function(e){return e.find(o)})).then((function(e){return function(e){if(e&&e.length){var r=e.map((function(e){return u(e)}));return Promise.all(r)}return Promise.resolve()}(function(e,r,t){var n=[];if(t&&t.length){var o=t.filter(a(e,r));n=o.map((function(e){return e.responseData}))}return n}(i,r,e))})).then((function(t){if(t&&t.length){var n=t.map((function(t){var n=t[0],o=t[1];return e.fillResponseBodyWithShreddedData(r,n,o)}));return Promise.all(n)}return Promise.resolve([])}))},o.prototype._getStore=function(){var e=this;return e._store?Promise.resolve(e._store):r.openStore(e._storeName).then((function(r){return e._store=r,e._store}))},o.prototype.put=function(r,t){n.log("Offline Persistence Toolkit OfflineCache: put() for Request with url: "+r.url);var o=this,i=[];return i.push(e.constructRequestResponseCacheData(r,t)),i.push(e.shredResponse(r,t)),Promise.all(i).then((function(r){return o._getStore().then((function(t){var o=r[0],i=r[1];if(i){var a=[];return o.value.responseData.bodyAbstract=function(e){var r=e.map((function(e){return{name:e.name,keys:e.keys?e.keys.reduce((function(e,r){return r?e.push(r.toString()):n.warn("should not have undefined key in the shredded data"),e}),[]):e.keys,resourceType:e.resourceType}}));return JSON.stringify(r)}(i),a.push(t.upsert(o.key,o.metadata,o.value)),a.push(e.cacheShreddedData(i)),Promise.all(a)}return t.upsert(o.key,o.metadata,o.value)}))}))},o.prototype.delete=function(r,t){if(!r)return n.warn("Offline Persistence Toolkit OfflineCache: delete() request is a required parameter. To clear the cache, please call clear()"),Promise.resolve(!1);n.log("Offline Persistence Toolkit OfflineCache: delete() for Request with url: "+r.url);if(e.hasShredder(r)){var o=e.constructSearchCriteria(r,t);o.fields=["key","value"];var i,s=t&&t.ignoreVary;return this._getStore().then((function(e){return(i=e).find(o)})).then((function(t){if(t&&t.length){var o=t.filter(a(s,r,"value")),u=[];return o.forEach((function(r){u.push(i.removeByKey(r.key)),r.value.responseData.bodyAbstract&&r.value.responseData.bodyAbstract.length&&u.push(e.deleteShreddedData(JSON.parse(r.value.responseData.bodyAbstract)))})),Promise.all(u).then((function(){return n.log("Offline Persistence Toolkit OfflineCache: all matching entries are deleted from both the cache store and the shredded store."),!0})).catch((function(e){return n.log("Offline Persistence Toolkit OfflineCache: error occurred when deleting matched cache entries."),!1}))}return n.log("Offline Persistence Toolkit OfflineCache: no matching entries are found from the cache."),!1}))}return this._getStore().then((function(e){return f(e,r,t).then((function(r){if(r&&r.length){var t=r.map(e.removeByKey,e);return Promise.all(t)}return!1}))})).then((function(e){return!(!e||!e.length)}))},o.prototype.keys=function(e,r){e?n.log("Offline Persistence Toolkit OfflineCache: keys() for Request with url: "+e.url):n.log("Offline Persistence Toolkit OfflineCache: keys()");return this._getStore().then((function(n){return f(n,e,r).then((function(e){var r=[];return e.forEach((function(e){r.push(n.findByKey(e).then((function(e){return t.requestFromJSON(e.requestData)})))})),Promise.all(r)}))}))},o.prototype.hasMatch=function(r,t){n.log("Offline Persistence Toolkit OfflineCache: hasMatch() for Request with url: "+r.url);var o=e.constructSearchCriteria(r,t),a=t&&t.ignoreVary;return this._getStore().then((function(e){return e.find(o).then((function(e){return null!==i(a,r,e)}))}))},o.prototype.clear=function(){n.log("Offline Persistence Toolkit OfflineCache: clear()");var e=this,r=[];return this.keys().then((function(t){return t.forEach((function(t,n,o){r.push(e.delete(t))})),Promise.all(r)})).then((function(e){var r=!1;return e.forEach((function(e){e||(r=!0)})),!r}))},o}));