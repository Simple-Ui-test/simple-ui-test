define(["./logger"],(function(r){"use strict";function e(r,e){var n=!1;for(var i in e)if(e.hasOwnProperty(i)){var o=e[i];if(n||!t(i))throw new Error("parsing error "+e);r.operator=i,r.right=o,n=!0}}function n(r){return"$and"===r||"$or"===r}function t(r){return"$lt"===r||"$gt"===r||"$lte"===r||"$gte"===r||"$eq"===r||"$ne"===r||"$regex"===r||"$exists"===r}function i(r){return null!=r&&(r instanceof String||"string"==typeof r)}function o(r,e){return i(r)&&null==e?e="":i(e)&&null==r&&(r=""),[r,e]}function a(r,e){for(var n=r.split("."),t=e,i=0;i<n.length;i++)t=t[n[i]];return t}return{satisfy:function(i,f){return r.log("Offline Persistence Toolkit storageUtils: Processing selector: "+JSON.stringify(i)),!i||function r(e,i){var f=e.operator;if(n(f)){if(!e.left&&e.array instanceof Array){for(var l,s=e.array,u=0;u<s.length;u++){var g=r(s[u],i);if("$or"===f&&!0===g)return!0;if("$and"===f&&!1===g)return!1;l=g}return l}throw new Error("invalid expression tree!"+e)}if(t(f)){var h=a(e.left,i),v=e.right;if("$lt"===f){var $=o(h,v);return h=$[0],v=$[1],h<v}if("$gt"===f){$=o(h,v);return h=$[0],v=$[1],h>v}if("$lte"===f){$=o(h,v);return h=$[0],v=$[1],h<=v}if("$gte"===f){$=o(h,v);return h=$[0],v=$[1],h>=v}if("$eq"===f)return h===v;if("$ne"===f)return h!==v;if("$regex"===f)return null!==h.match(v);if("$exists"===f)return v?null!=h:null==h;throw new Error("not a valid expression! "+e)}throw new Error("not a valid expression!"+e)}(function r(i){var o,a=[];for(var f in i)if(i.hasOwnProperty(f)){var l=i[f];if(0===f.indexOf("$")){if(n(f)){if(!(l instanceof Array))throw new Error("not a valid expression: "+i);o={operator:f,array:[]};for(var s=0;s<l.length;s++){var u=r(l[s]);o.array.push(u)}}else if(t(f))throw new Error("not a valid expression: "+i)}else if("object"!=typeof l)a.push({left:f,right:l,operator:"$eq"});else{var g={left:f};e(g,l),a.push(g)}}a.length>1?o={operator:"$and",array:a}:1===a.length&&(o=a[0]);return o}(i),f)},getValue:a,assembleObject:function(r,e){var n;if(e){n={};for(var t=0;t<e.length;t++)for(var i=n,o=r,a=e[t].split("."),f=0;f<a.length;f++)o=o[a[f]],!i[a[f]]&&f<a.length-1&&(i[a[f]]={}),f===a.length-1?i[a[f]]=o:i=i[a[f]]}else n=r;return n}}}));