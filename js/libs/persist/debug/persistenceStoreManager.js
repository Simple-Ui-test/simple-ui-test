define(["./impl/logger","./impl/PersistenceStoreMetadata","./pouchDBPersistenceStoreFactory"],(function(e,t,r){"use strict";var o=function(){Object.defineProperty(this,"_stores",{value:{},writable:!0}),Object.defineProperty(this,"_factories",{value:{},writable:!0}),Object.defineProperty(this,"_DEFAULT_STORE_FACTORY_NAME",{value:"_defaultFactory",writable:!1}),Object.defineProperty(this,"_METADATA_STORE_NAME",{value:"systemCache-metadataStore",writable:!1}),Object.defineProperty(this,"_storeNameMapping",{value:{},writable:!0})};return o.prototype.registerStoreFactory=function(e,t){if(!t)throw TypeError("A valid factory must be provided.");if(!e)throw TypeError("A valid name must be provided.");var r=this._mapStoreName(e),o=this._factories[r];if(o&&o!==t)throw TypeError("A factory with the same name has already been registered.");this._factories[r]=t},o.prototype.registerDefaultStoreFactory=function(e){this.registerStoreFactory(this._DEFAULT_STORE_FACTORY_NAME,e)},o.prototype.openStore=function(r,o){e.log("Offline Persistence Toolkit PersistenceStoreManager: openStore() for name: "+r);var n=this._mapStoreName(r),i=this._stores[n],a=o&&o.version||"0";if(i&&i[a])return Promise.resolve(i[a]);var s=this._factories[n];if(s||(s=this._factories[this._DEFAULT_STORE_FACTORY_NAME]),!s)return Promise.reject(new Error("no factory is registered to create the store."));var c=this;return e.log("Offline Persistence Toolkit PersistenceStoreManager: Calling createPersistenceStore on factory"),s.createPersistenceStore(n,o).then((function(e){(i=i||{})[a]=e,c._stores[n]=i;new t(n,s,Object.keys(i));return c._getMetadataStore().then((function(e){var t=c._encodeString(n);return e.upsert(t,{},Object.keys(i))})).then((function(){return e}))}))},o.prototype.hasStore=function(e,t){var r=this._mapStoreName(e),o=this._stores[r];return!!o&&(!t||!t.version||!!o[t.version])},o.prototype.deleteStore=function(t,r){e.log("Offline Persistence Toolkit PersistenceStoreManager: deleteStore() for name: "+t);var o=this,n=this._mapStoreName(t);return new Promise((function(e,t){var i={};if(i.options=r,i.self=o,!o._stores[n])return o.getStoresMetadata().then((function(e){var t=[],r=e.get(n);return r&&r.versions&&r.versions.forEach((function(e){t.push(o.openStore(n,e))})),Promise.all(t)})).then((function(){e(i)}));e(i)})).then((function(t){var r,o=t.self,i=t.options,a=o._stores[n];if(a){var s=i&&i.version;if(s){var c=a[s];return c?(e.log("Offline Persistence Toolkit PersistenceStoreManager: Calling delete on store"),c.delete().then((function(){return delete a[s],o._getMetadataStore().then((function(e){if(a&&Object.keys(a).length>0){var t=o._encodeString(n);return e.upsert(t,null,Object.keys(a))}return e.removeByKey(n)}))})).then((function(){return!0}))):Promise.resolve(!1)}var u=Object.keys(a).map((r=a,function(e){return r[e].delete()}),this);return Promise.all(u).then((function(){return delete o._stores[n],o._getMetadataStore().then((function(e){var t=o._encodeString(n);return e.removeByKey(t)})).then((function(){return!0}))}))}return Promise.resolve(!1)}))},o.prototype.getStoresMetadata=function(){var e=this;return this._getMetadataStore().then((function(r){return r.keys().then((function(o){var n=[];return o.forEach((function(o){n.push(r.findByKey(o).then((function(r){var n=r,i=e._decodeString(o),a=e._factories[i];return a||(a=e._factories[e._DEFAULT_STORE_FACTORY_NAME]),new t(i,a,n)})))})),Promise.all(n)})).then((function(e){var t=new Map;return e.forEach((function(e){t.set(e.name,e)})),t}))}))},o.prototype._mapStoreName=function(e,t){var r=this._storeNameMapping[e];return r||(r=e.replace(/(.*):\/\/(.*)/gi,"$1$2"),this._storeNameMapping[e]=r,r)},o.prototype._getMetadataStore=function(){var e=this;return e._metadataStore?Promise.resolve(e._metadataStore):(this._factories[this._DEFAULT_STORE_FACTORY_NAME]||(this._factories[e._METADATA_STORE_NAME]=r),this.openStore(e._METADATA_STORE_NAME).then((function(t){return e._metadataStore=t,e._metadataStore})))},o.prototype._encodeString=function(e){for(var t=[],r=0;r<e.length;r++){var o=Number(e.charCodeAt(r)).toString(16);t.push(o)}return t.join("")},o.prototype._decodeString=function(e){var t,r=e.toString(),o="";for(t=0;t<r.length;t+=2)o+=String.fromCharCode(parseInt(r.substr(t,2),16));return o},new o}));