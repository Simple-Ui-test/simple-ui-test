define(["./persistenceManager","./persistenceUtils","./fetchStrategies","./cacheStrategies","./persistenceStoreManager","./impl/defaultCacheHandler","./impl/logger"],(function(e,n,t,r,o,s,i){"use strict";function l(e){null==(e=e||{}).fetchStrategy&&(e.fetchStrategy=t.getCacheIfOfflineStrategy()),null==e.cacheStrategy&&(e.cacheStrategy=r.getHttpCacheHeaderStrategy()),e.requestHandlerOverride=e.requestHandlerOverride||{},null==e.requestHandlerOverride.handleGet&&(e.requestHandlerOverride.handleGet=this.handleGet),null==e.requestHandlerOverride.handlePost&&(e.requestHandlerOverride.handlePost=this.handlePost),null==e.requestHandlerOverride.handlePut&&(e.requestHandlerOverride.handlePut=this.handlePut),null==e.requestHandlerOverride.handlePatch&&(e.requestHandlerOverride.handlePatch=this.handlePatch),null==e.requestHandlerOverride.handleDelete&&(e.requestHandlerOverride.handleDelete=this.handleDelete),null==e.requestHandlerOverride.handleHead&&(e.requestHandlerOverride.handleHead=this.handleHead),null==e.requestHandlerOverride.handleOptions&&(e.requestHandlerOverride.handleOptions=this.handleOptions),Object.defineProperty(this,"_options",{value:e})}function u(n){if(e.isOnline())return e.browserFetch(n);return Promise.resolve(new Response(null,{status:503,statusText:"Must provide handlePost override for offline"}))}function a(e,n){var t=e;return(0,t._options.fetchStrategy)(n,t._options)}function d(e,t){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing offline logic for default PUT Handler"),n.requestToJSON(t).then((function(e){e.status=200,e.statusText="OK",e.headers["content-type"]="application/json",e.headers["x-oracle-jscpt-cache-expiration-date"]="";var t=e.headers["if-match"],r=e.headers["if-none-match"];if(t||r){i.log("Offline Persistence Toolkit DefaultResponseProxy: Generating ETag for offline Response for default PUT Handler");var o=Math.floor(1e6*Math.random());e.headers.etag=(Date.now()+o).toString(),e.headers["x-oracle-jscpt-etag-generated"]=e.headers.etag,delete e.headers["if-match"],delete e.headers["if-none-match"]}return n.responseFromJSON(e)}))}function f(e,t){var r=e;return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing offline logic for default DELETE Handler"),n.requestToJSON(t).then((function(e){return e.status=200,e.statusText="OK",e.headers["content-type"]="application/json",e.headers["x-oracle-jscpt-cache-expiration-date"]="",n.responseFromJSON(e).then((function(s){var i=h(t),l=null;return r._options&&r._options.jsonProcessor&&r._options.jsonProcessor.shredder&&(l=r._options.jsonProcessor.shredder),l?l(s).then((function(t){if(t){var r=t[0].name;return o.openStore(r).then((function(t){return t.findByKey(i).then((function(t){return t?n.responseFromJSON(e).then((function(e){return n.setResponsePayload(e,t).then((function(e){return e}))})):s}))}))}return s})):s}))}))}function c(e,n,t,r){var o=e;return t.status<500?Promise.resolve(t):r(o,n)}function h(e){var n=e.url.split("/");return n[n.length-1]}function p(n,t,r){return!e.isOnline()||r?e.getSyncManager().insertRequest(n,{undoRedoDataArray:t}):Promise.resolve()}function h(e){var n=e.url.split("/");return n.length>1?n[n.length-1].split("?")[0]:null}return l.prototype.getFetchEventListener=function(){var e=this;return function(n){n.respondWith(e.processRequest(n.request))}},l.prototype.processRequest=function(t){var r=this,l=n.buildEndpointKey(t);return new Promise((function(u,a){s.registerEndpointOptions(l,r._options);var d=function(e,n){var t=e._options,r=null;"POST"===n.method?r=t.requestHandlerOverride.handlePost:"GET"===n.method?r=t.requestHandlerOverride.handleGet:"PUT"===n.method?r=t.requestHandlerOverride.handlePut:"PATCH"===n.method?r=t.requestHandlerOverride.handlePatch:"DELETE"===n.method?r=t.requestHandlerOverride.handleDelete:"HEAD"===n.method?r=t.requestHandlerOverride.handleHead:"OPTIONS"===n.method&&(r=t.requestHandlerOverride.handleOptions);return r}(r,t),f={},c=t.clone();i.log("Offline Persistence Toolkit DefaultResponseProxy: Calling requestHandler for request with enpointKey: "+l),d.call(r,t).then((function(e){return n.isCachedResponse(e)&&(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is cached for request with enpointKey: "+l),f.isCachedResponse=!0),e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for request with enpointKey: "+l),function(e,n,t){var r=e;return"GET"===n.method||"HEAD"===n.method?(0,r._options.cacheStrategy)(n,t,r._options):Promise.resolve(t)}(r,t,e)):(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is not ok for request with enpointKey: "+l),e)})).then((function(e){return f.response=e,e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok after cacheStrategy for request with enpointKey: "+l),function(e,n){return"GET"==e.method||"HEAD"==e.method?Promise.resolve():function(e,n){return s.constructShreddedData(e,n).then((function(n){return n?function(e,n){var t=[];return n.forEach((function(n){var r=Object.keys(n)[0];t.push(function(e,n,t){return function(e,n,t){var r,s,i=[],l=function(t,u){return t<u.length&&"GET"!==e.method&&"HEAD"!==e.method?(r=u[t].key.toString(),s="DELETE"!==e.method?u[t].value:null,o.openStore(n).then((function(e){return e.findByKey(r).then((function(e){return i.push({key:r,undo:e,redo:s}),l(++t,u)}),(function(e){return i.push({key:r,undo:null,redo:s}),l(++t,u)}))}))):Promise.resolve(i)};return l(0,t)}(e,n,t).then((function(r){if("DELETE"===e.method){if(!t||0===t.length){var s=h(e);t=[{key:s}]}return function(e,n,t){return o.openStore(e).then((function(e){return e.removeByKey(n[0].key)})).then((function(){return t.length>0?{storeName:e,operation:"remove",undoRedoData:t}:null}))}(n,t,r)}return function(e,n,t){return o.openStore(e).then((function(e){return e.upsertAll(n)})).then((function(){return t.length>0?{storeName:e,operation:"upsert",undoRedoData:t}:null}))}(n,t,r)}))}(e,r,n[r]))})),Promise.all(t)}(e,n):Promise.resolve()}))}(e,n)}(t,e)):(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is not ok after cacheStrategy for request with enpointKey: "+l),null)})).then((function(n){return p(t,n,f.isCachedResponse&&!e.isOnline())})).then((function(){s.unregisterEndpointOptions(l),u(f.response)})).catch((function(e){i.log("Offline Persistence Toolkit DefaultResponseProxy: Insert Response in syncManager after error for request with enpointKey: "+l),p(c,null,!0).then((function(){s.unregisterEndpointOptions(l),a(e)}),(function(){s.unregisterEndpointOptions(l),a(e)}))}))}))},l.prototype.handlePost=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default POST Handler"),u(e)},l.prototype.handleGet=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default GET Handler"),a(this,e)},l.prototype.handleHead=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default HEAD Handler"),a(this,e)},l.prototype.handleOptions=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default OPTIONS Handler"),u(e)},l.prototype.handlePut=function(n){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default PUT Handler"),function(n,t){var r=n;return e.isOnline()?e.browserFetch(t.clone()).then((function(e){return e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for default PUT Handler"),e):c(r,t,e,d)}),(function(e){return d(r,t)})):d(r,t)}(this,n)},l.prototype.handlePatch=function(e){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default PATCH Handler"),u(e)},l.prototype.handleDelete=function(n){return i.log("Offline Persistence Toolkit DefaultResponseProxy: Processing Request with default DELETE Handler"),function(n,t){var r=n;return e.isOnline()?e.browserFetch(t.clone()).then((function(e){return e.ok?(i.log("Offline Persistence Toolkit DefaultResponseProxy: Response is ok for default DELETE Handler"),e):c(r,t,e,f)}),(function(e){return f(r,t)})):f(r,t)}(this,n)},{getResponseProxy:function(e){return new l(e)}}}));